# .github/workflows/indexer.yml
name: indexer

on:
  workflow_dispatch:
  schedule:
    - cron: "*/2 * * * *" # каждые 10 минут
  push:
    paths:
      - "backend/**"
      - ".github/workflows/indexer.yml"

permissions:
  contents: read

concurrency:
  group: indexer
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install deps
        run: npm ci --no-fund --no-audit

      - name: Run indexer (build JSON + push to Worker)
        env:
          # Chain & RPC
          CHAIN_ID: "534351"
          SCROLL_RPC: ${{ secrets.SCROLL_RPC }}

          # Contract address (единственный источник истины)
          FACTORY_ADDRESS: "0x25465982fD4A87054c69d874cd6D89f69e1DE35c"

          # Опционально: START_BLOCK можно задать вручную или убрать
          ONLY_LAST_BLOCKS: "2000"

          # Cloudflare Worker API (без /api на конце!)
          API_BASE: ${{ secrets.API_BASE }} # ← должно быть: https://api.dscope.app
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }} # ← тот же токен, что в Worker Settings

          # Output dir для артефактов (локально в CI)
          OUTPUT_DIR: "./out-api"

        run: npx tsx backend/ci-indexer.ts

      - name: Sanity check output
        run: |
          test -f ./out-api/surveys.list.json
          jq 'length' ./out-api/surveys.list.json

      - name: Upload artifacts (optional, for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: out-api
          path: ./out-api
