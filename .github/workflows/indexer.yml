name: indexer

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"
  push:
    paths:
      - "backend/**"
      - ".github/workflows/indexer.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dscope-core
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run indexer (build JSON)
        env:
          # --- сеть Scroll Sepolia ---
          ZKSYNC_RPC: "https://sepolia-rpc.scroll.io" # ci-indexer.ts читает ZKSYNC_RPC или RPC_URL
          RPC_URL: "https://sepolia-rpc.scroll.io"
          CHAIN_ID: "534351"

          # --- фабрика(и) на Scroll ---
          FACTORY: "0x25465982fD4A87054c69d874cd6D89f69e1DE35c"
          FACTORIES: '["0x25465982fD4A87054c69d874cd6D89f69e1DE35c"]'

          # --- откуда сканить логи ---
          START_BLOCK: "PUT_DEPLOY_BLOCK" # поставь блок деплоя фабрики
          ONLY_LAST_BLOCKS: "0" # можно поставить "100000" чтобы ускорить первый прогон
          MIN_CONF: "2"

          # --- опционально ---
          TREASURY_SAFE: "0xABfd53eB3C6c2453bED90fa756ffE509e35eB60b"
          GATE_ADDR: "0x912bB1eD08b82f8BE19EcCcf2F271eCe28364b3a"

          # --- куда складываем артефакты перед публикацией ---
          OUTPUT_DIR: "./out-api"
        run: npx ts-node --transpile-only backend/ci-indexer.ts

      - name: Checkout dscope-api (publish static API)
        uses: actions/checkout@v4
        with:
          repository: D-Scope-app/dscope-api
          token: ${{ secrets.API_PUSH_TOKEN }}
          path: api-repo
          persist-credentials: false

      - name: Publish API artifacts
        run: |
          rsync -a --delete ./out-api/ ./api-repo/api/
          cd api-repo
          git config user.email "bot@dscope.app"
          git config user.name "dscope-bot"
          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
          else
            git commit -m "ci(indexer): refresh artifacts"
            git push https://x-access-token:${{ secrets.API_PUSH_TOKEN }}@github.com/D-Scope-app/dscope-api HEAD:main
          fi
