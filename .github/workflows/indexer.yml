name: indexer

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # каждые 10 минут
  push:
    paths:
      - "backend/**"
      - ".github/workflows/indexer.yml"

# Нам не нужны расширенные права, т.к. мы больше ничего не пушим
permissions:
  contents: read

concurrency:
  group: indexer
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install deps
        run: npm ci --no-fund --no-audit

      - name: Run indexer (build JSON + push to Worker)
        env:
          # ====== chain / rpc / contracts ======
          FACTORY_ADDRESS: "0x25465982fD4A87054c69d874cd6D89f69e1DE35c"
          SCROLL_RPC: ${{ secrets.SCROLL_RPC }}
          CHAIN_ID: "534351"

          FACTORY: ${{ vars.FACTORY }}
          FACTORIES: ${{ vars.FACTORIES }}

          START_BLOCK: ${{ vars.START_BLOCK }} # можно не задавать
          ONLY_LAST_BLOCKS: ${{ vars.ONLY_LAST_BLOCKS || '0' }}
          MIN_CONF: ${{ vars.MIN_CONF || '2' }}
          TREASURY_SAFE: ${{ vars.TREASURY_SAFE }}
          GATE_ADDR: ${{ vars.GATE_ADDR }}

          # куда положить локальные файлы сборки (для артефакта)
          OUTPUT_DIR: "./out-api"

          # ====== публикация в Cloudflare Worker ======
          API_BASE: ${{ secrets.API_BASE }} # ДОЛЖНО быть: https://api.dscope.app   (без /api)
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }} # тот же токен, что в Settings воркера
        run: npx tsx backend/ci-indexer.ts

      - name: Sanity check output (optional)
        run: |
          test -f ./out-api/surveys.list.json
          jq 'length' ./out-api/surveys.list.json

      # не обязательно, но удобно видеть, что именно собралось
      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: out-api
          path: ./out-api
