name: indexer

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # каждые 10 минут
  push:
    paths:
      - "backend/**"
      - "deployments/**"
      - ".github/workflows/indexer.yml"

concurrency:
  group: indexer
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout core
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci --no-fund --no-audit
      - name: Compile (for ABIs)
        run: npx hardhat compile

      - name: Run indexer (build JSON)
        env:
          RPC: "https://sepolia-rpc.scroll.io"
          CHAIN_ID: "534351"

          FACTORY: "0x25465982fD4A87054c69d874cd6D89f69e1DE35c"
          FACTORIES: '["0x25465982fD4A87054c69d874cd6D89f69e1DE35c"]'

          ONLY_LAST_BLOCKS: "50000"
          MIN_CONF: "2"
          OUTPUT_DIR: "./out-api"
        run: npx ts-node --transpile-only backend/ci-indexer.ts

      - name: Checkout dscope-api
        uses: actions/checkout@v4
        with:
          repository: D-Scope-app/dscope-api
          token: ${{ secrets.API_PUSH_TOKEN }}
          path: api-repo

      - name: Publish API artifacts
        run: |
          rsync -a --delete ./out-api/ ./api-repo/api/
          cd api-repo
          git config user.email "bot@dscope.app"
          git config user.name  "dscope-bot"
          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
          else
            git commit -m "ci(indexer): refresh artifacts"
            git push
          fi
