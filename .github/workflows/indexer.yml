name: indexer

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "contracts/**"
      - "deployments/**"
      - ".github/workflows/indexer.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dscope-core
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # npm ci требует package-lock.json — используем install
      - name: Install deps
        run: |
          npm install --no-audit --no-fund

      - name: Compile contracts (hardhat)
        run: npx hardhat compile

      - name: Run indexer (build JSON)
        env:
          # --- сеть Scroll Sepolia ---
          ZKSYNC_RPC: "https://sepolia-rpc.scroll.io"
          CHAIN_ID: "534351"

          # фабрика и пр.
          FACTORY: "0x25465982fD4A87054c69d874cd6D89f69e1DE35c"
          FACTORIES: '["0x25465982fD4A87054c69d874cd6D89f69e1DE35c"]'

          START_BLOCK: "0"
          ONLY_LAST_BLOCKS: "0"
          MIN_CONF: "2"
          GATE_ADDR_HINT: "0x912bB1ed08b82f8BE19eCcCF2f271eCe28364B3A"

          # куда сложить артефакты для публикации
          OUTPUT_DIR: "./out-api"
        run: npx ts-node --transpile-only backend/ci-indexer.ts

      - name: Checkout dscope-api (publish static API)
        uses: actions/checkout@v4
        with:
          repository: D-Scope-app/dscope-api
          token: ${{ secrets.API_PUSH_TOKEN }}
          path: api-repo

      - name: Publish API artifacts
        run: |
          rsync -a --delete ./out-api/ ./api-repo/api/
          cd api-repo
          git config user.email "bot@dscope.app"
          git config user.name "dscope-bot"
          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
          else
            git commit -m "ci(indexer): refresh artifacts"
            git push
          fi
